# 自动恢复系统文档

## 问题背景

用户反馈程序在AI处理过程中经常卡死，特别是在显示"AI继续处理..."后长时间无响应。这种情况下用户只能强制关闭程序，影响使用体验。

## 解决方案

实现了一个智能的**输出监控和自动恢复系统**，当检测到程序超过15秒无输出时，自动发送恢复指令给AI，让AI继续完成任务。

## 系统架构

### 1. 输出监控器 (`src/output_monitor.py`)

#### 核心功能：
- ✅ **实时监控**：监控所有程序输出（print和stdout）
- ✅ **超时检测**：15秒无输出自动触发恢复
- ✅ **线程安全**：使用线程锁保证安全
- ✅ **自动清理**：异常情况下自动清理资源

#### 技术实现：
```python
class OutputMonitor:
    def __init__(self, timeout_seconds=15):
        self.timeout_seconds = timeout_seconds
        self.last_output_time = time.time()
        # 监控线程和同步机制
```

#### 监控机制：
1. **Print函数重写**：拦截所有print调用
2. **Stdout重写**：拦截所有标准输出
3. **时间戳更新**：每次输出自动更新时间戳
4. **后台监控**：独立线程检查输出间隔

### 2. 自动恢复策略

#### 分级恢复机制：
```python
# 第1次恢复
"检测到可能的卡死情况。请继续完成当前任务，如果遇到问题请分析并解决。"

# 第2次恢复  
"再次检测到无响应。请检查当前状态，如果有错误请修复，然后继续任务。"

# 第3次恢复
"多次检测到无响应。请总结当前进度，如果任务已完成请使用task_complete结束。"
```

#### 恢复限制：
- ✅ **最大恢复次数**：3次，防止无限恢复
- ✅ **恢复间隔**：每次15秒超时后触发
- ✅ **智能停止**：达到上限后自动停止监控

### 3. 集成到命令处理器 (`src/command_processor.py`)

#### 工作流程：
```
用户输入 → 启动监控 → AI处理 → 检测超时 → 自动恢复 → 继续处理 → 完成/停止
```

#### 关键改进：
- ✅ **全程监控**：整个AI对话过程都有监控
- ✅ **智能恢复**：根据恢复次数调整策略
- ✅ **异常处理**：确保监控器正确清理
- ✅ **用户提示**：明确显示恢复状态

## 使用效果

### 修复前：
```
AI继续处理... (第4次)
规划...提示: 按ESC键可随时停止任务
[程序卡死，无响应]
```

### 修复后：
```
AI继续处理... (第4次)
规划...提示: 按ESC键可随时停止任务
[15秒后]
⚠️ 检测到程序超过15秒无输出，可能卡死
正在自动恢复...
🔄 自动恢复 (1/3)...
🤖 AI: 我来继续完成任务...
```

## 技术特点

### 1. 非侵入式监控
- 不影响原有代码逻辑
- 透明的输出拦截
- 自动启用和清理

### 2. 智能恢复策略
- 分级恢复消息
- 恢复次数限制
- 上下文感知

### 3. 健壮的错误处理
- 异常安全
- 资源自动清理
- 线程安全

### 4. 用户友好
- 明确的状态提示
- 进度显示
- 可配置超时时间

## 配置选项

### 超时时间设置：
```python
# 默认15秒
start_output_monitoring(timeout_callback, timeout_seconds=15)

# 自定义超时时间
start_output_monitoring(timeout_callback, timeout_seconds=30)
```

### 最大恢复次数：
```python
max_recoveries = 3  # 可在命令处理器中调整
```

## 测试验证

### 测试场景：
1. ✅ **基础监控**：检测无输出超时
2. ✅ **正常操作**：正常输出不触发恢复
3. ✅ **静默恢复**：静默后自动恢复
4. ✅ **多次恢复**：多次超时的处理
5. ✅ **并发操作**：多线程环境下的稳定性

### 测试结果：
```
✅ 所有自动恢复测试完成
- 基础监控功能正常
- 正常操作不会误触发
- 静默后能正确恢复
- 多次恢复机制有效
- 并发环境稳定
```

## 使用指南

### 自动启用：
程序启动时自动启用输出监控，无需手动配置。

### 手动控制：
```python
# 启用监控
enable_print_monitoring()
start_output_monitoring(callback)

# 停止监控
stop_output_monitoring()
disable_print_monitoring()
```

### 故障排除：
1. **恢复失败**：检查网络连接和API配置
2. **误触发**：调整超时时间参数
3. **无法恢复**：手动按ESC或Ctrl+C中断

## 未来改进

### 计划功能：
1. **智能超时调整**：根据任务复杂度动态调整超时时间
2. **恢复策略学习**：根据历史成功率优化恢复消息
3. **用户自定义**：允许用户自定义恢复策略
4. **性能监控**：监控CPU和内存使用情况

### 可能优化：
1. **更精确的卡死检测**：区分真正的卡死和正常的长时间处理
2. **上下文感知恢复**：根据当前任务类型选择恢复策略
3. **渐进式超时**：第一次15秒，第二次30秒，逐渐增加
4. **用户交互**：恢复前询问用户是否继续

## 总结

自动恢复系统有效解决了程序卡死问题：

1. ✅ **问题解决**：15秒无输出自动恢复，避免卡死
2. ✅ **用户体验**：无需手动干预，自动处理异常
3. ✅ **智能策略**：分级恢复，逐步升级处理方式
4. ✅ **系统稳定**：健壮的错误处理和资源管理

现在用户可以放心使用sprint模式进行长时间的开发任务，系统会自动处理可能的卡死情况，确保任务能够顺利完成。
